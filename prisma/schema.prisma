generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  name                   String?
  passwordHash           String
  financeEntities        FinanceEntity[]
  monthlyOverviewEntries MonthlyOverviewEntry[]
  walletAccounts         WalletAccount[]
  creditAccounts         CreditAccount[]
  investments            Investment[]
  incomeStreams          IncomeStream[]
  budgetEnvelopes        BudgetEnvelope[]
  loanRecords            LoanRecord[]
  financeTransactions    FinanceTransaction[]
  importBatches          ImportBatch[]
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
}

enum WalletAccountType {
  CASH
  BANK
  E_WALLET
  ASSET
  CREDIT_CARD
}

enum TransactionKind {
  INCOME
  EXPENSE
  BUDGET_ALLOCATION
  TRANSFER
  CREDIT_CARD_CHARGE
  CREDIT_CARD_PAYMENT
  LOAN_BORROW
  LOAN_REPAY
  ADJUSTMENT
}

enum AdjustmentReasonCode {
  OPENING_BALANCE
  BALANCE_CORRECTION
  IMPORT_BOOTSTRAP
  SYSTEM_RECONCILIATION
  MANUAL_FIX
}

enum LoanDirection {
  YOU_OWE
  YOU_ARE_OWED
}

enum LoanStatus {
  ACTIVE
  INACTIVE
  PAID
  WRITTEN_OFF
}

enum EntityType {
  PERSONAL
  BUSINESS
}

enum BudgetEnvelopeSystemType {
  TRANSFER
  CREDIT_CARD_PAYMENT
  LOAN_INFLOW
  LOAN_PAYMENT
}

enum ImportMode {
  BALANCE_BOOTSTRAP
  FULL_LEDGER
}

enum ImportBatchStatus {
  STAGED
  COMMITTING
  COMMITTED
  FAILED
}

enum ImportRowStatus {
  STAGED
  COMMITTED
  FAILED
}

model FinanceEntity {
  id             String               @id @default(cuid())
  userId         String
  name           String
  type           EntityType
  isArchived     Boolean              @default(false)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallets        WalletAccount[]
  creditAccounts CreditAccount[]
  investments    Investment[]
  budgets        BudgetEnvelope[]
  loans          LoanRecord[]
  incomeStreams  IncomeStream[]
  transactions   FinanceTransaction[]
  importBatches  ImportBatch[]

  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([userId, isArchived, createdAt])
}

model MonthlyOverviewEntry {
  id           String   @id @default(cuid())
  userId       String
  entryDate    DateTime
  walletAmount Decimal
  remarks      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, entryDate])
}

model WalletAccount {
  id                     String               @id @default(cuid())
  userId                 String
  entityId               String?
  name                   String
  type                   WalletAccountType
  currentBalanceAmount   Decimal              @default(0)
  isArchived             Boolean              @default(false)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity                 FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  sourceTransactions     FinanceTransaction[] @relation("TransactionSourceWallet")
  targetTransactions     FinanceTransaction[] @relation("TransactionTargetWallet")
  linkedPaymentEnvelopes BudgetEnvelope[]     @relation("BudgetEnvelopeLinkedWallet")

  @@index([userId, type, isArchived])
  @@index([userId, isArchived, name])
  @@index([entityId, type, isArchived])
  @@index([entityId, isArchived, name])
}

model CreditAccount {
  id                     String           @id @default(cuid())
  userId                 String
  entityId               String
  name                   String
  creditLimitAmount      Decimal          @default(0)
  currentBalanceAmount   Decimal          @default(0)
  isArchived             Boolean          @default(false)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  user                   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity                 FinanceEntity    @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  linkedPaymentEnvelopes BudgetEnvelope[] @relation("BudgetEnvelopeLinkedCreditAccount")

  @@index([userId, isArchived, name])
  @@index([entityId])
  @@index([entityId, isArchived])
  @@index([entityId, isArchived, name])
  @@index([userId, entityId, isArchived, name])
}

model Investment {
  id                   String        @id @default(cuid())
  userId               String
  entityId             String
  name                 String
  initialInvestmentPhp Decimal       @default(0)
  value                Decimal       @default(0)
  remarks              String?
  isArchived           Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity               FinanceEntity @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId, isArchived, name])
  @@index([userId, createdAt])
  @@index([entityId])
  @@index([entityId, isArchived])
  @@index([entityId, isArchived, name])
  @@index([userId, entityId, isArchived, name])
  @@index([entityId, createdAt])
}

model IncomeStream {
  id               String               @id @default(cuid())
  userId           String
  entityId         String?
  name             String
  defaultAmountPhp Decimal              @default(0)
  isActive         Boolean              @default(true)
  remarks          String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity           FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  transactions     FinanceTransaction[]

  @@index([userId, isActive])
  @@index([entityId, isActive])
}

model BudgetEnvelope {
  id                    String                    @id @default(cuid())
  userId                String
  entityId              String?
  name                  String
  monthlyTargetPhp      Decimal                   @default(0)
  availablePhp          Decimal                   @default(0)
  rolloverEnabled       Boolean                   @default(true)
  payTo                 String?
  remarks               String?
  isSystem              Boolean                   @default(false)
  systemType            BudgetEnvelopeSystemType?
  linkedWalletAccountId String?
  linkedCreditAccountId String?
  isArchived            Boolean                   @default(false)
  sortOrder             Int                       @default(0)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity                FinanceEntity?            @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  linkedWalletAccount   WalletAccount?            @relation("BudgetEnvelopeLinkedWallet", fields: [linkedWalletAccountId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  linkedCreditAccount   CreditAccount?            @relation("BudgetEnvelopeLinkedCreditAccount", fields: [linkedCreditAccountId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  transactions          FinanceTransaction[]
  ccPaymentTransactions FinanceTransaction[]      @relation("TransactionCcPaymentEnvelope")

  @@index([userId, isArchived, isSystem, sortOrder])
  @@index([userId, name])
  @@index([entityId, isArchived])
  @@index([entityId, isArchived, isSystem, sortOrder])
  @@index([entityId, name])
  @@index([entityId, systemType, isArchived])
  @@index([entityId, systemType, linkedWalletAccountId])
  @@index([entityId, systemType, linkedCreditAccountId])
}

model LoanRecord {
  id            String               @id @default(cuid())
  userId        String
  entityId      String?
  direction     LoanDirection
  itemName      String
  counterparty  String?
  principalPhp  Decimal
  monthlyDuePhp Decimal?
  paidToDatePhp Decimal              @default(0)
  remainingPhp  Decimal
  status        LoanStatus           @default(ACTIVE)
  startDate     DateTime?
  remarks       String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity        FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  transactions  FinanceTransaction[]

  @@index([userId, direction, status])
  @@index([userId, status])
  @@index([entityId, direction, status])
  @@index([entityId, status])
}

model ImportBatch {
  id             String               @id @default(cuid())
  userId         String
  entityId       String
  sourceFileName String
  sourceFileHash String
  importMode     ImportMode
  status         ImportBatchStatus    @default(STAGED)
  errorMessage   String?
  committedAt    DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity         FinanceEntity        @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  rows           ImportRow[]
  transactions   FinanceTransaction[]

  @@index([userId, entityId, createdAt])
  @@index([entityId, status, createdAt])
  @@index([userId, sourceFileHash, createdAt])
}

model ImportRow {
  id             String          @id @default(cuid())
  batchId        String
  sheetName      String
  rowIndex       Int
  rowHash        String
  idempotencyKey String          @unique
  payloadJson    Json
  status         ImportRowStatus @default(STAGED)
  errorMessage   String?
  committedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  batch          ImportBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([batchId, status, rowIndex])
  @@index([sheetName, rowIndex])
}

model FinanceTransaction {
  id                    String                @id @default(cuid())
  userId                String
  actorUserId           String
  entityId              String?
  externalId            String?
  importBatchId         String?
  postedAt              DateTime              @default(now())
  kind                  TransactionKind
  amountPhp             Decimal
  walletAccountId       String
  targetWalletAccountId String?
  budgetEnvelopeId      String?
  ccPaymentEnvelopeId   String?
  incomeStreamId        String?
  loanRecordId          String?
  adjustmentReasonCode  AdjustmentReasonCode?
  isReversal            Boolean               @default(false)
  reversedTransactionId String?               @unique
  voidedAt              DateTime?
  voidedByUserId        String?
  countsTowardBudget    Boolean               @default(true)
  remarks               String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity                FinanceEntity?        @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  walletAccount         WalletAccount         @relation("TransactionSourceWallet", fields: [walletAccountId], references: [id], onDelete: Restrict)
  targetWalletAccount   WalletAccount?        @relation("TransactionTargetWallet", fields: [targetWalletAccountId], references: [id], onDelete: SetNull)
  budgetEnvelope        BudgetEnvelope?       @relation(fields: [budgetEnvelopeId], references: [id], onDelete: SetNull)
  ccPaymentEnvelope     BudgetEnvelope?       @relation("TransactionCcPaymentEnvelope", fields: [ccPaymentEnvelopeId], references: [id], onDelete: SetNull)
  incomeStream          IncomeStream?         @relation(fields: [incomeStreamId], references: [id], onDelete: SetNull)
  loanRecord            LoanRecord?           @relation(fields: [loanRecordId], references: [id], onDelete: SetNull)
  importBatch           ImportBatch?          @relation(fields: [importBatchId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  reversedTransaction   FinanceTransaction?   @relation("TransactionReversal", fields: [reversedTransactionId], references: [id], onDelete: SetNull)
  reversalTransaction   FinanceTransaction?   @relation("TransactionReversal")

  @@index([userId, postedAt])
  @@index([userId, kind, postedAt])
  @@index([userId, budgetEnvelopeId, postedAt])
  @@index([userId, walletAccountId, postedAt])
  @@index([entityId, createdAt])
  @@index([entityId, kind, createdAt])
  @@index([entityId, walletAccountId, createdAt])
  @@index([entityId, targetWalletAccountId, createdAt])
  @@index([entityId, budgetEnvelopeId, createdAt])
  @@index([entityId, postedAt])
  @@index([entityId, kind, postedAt])
  @@index([entityId, externalId])
  @@index([importBatchId, postedAt])
  @@index([entityId, budgetEnvelopeId, postedAt])
  @@index([entityId, ccPaymentEnvelopeId, postedAt])
  @@index([entityId, walletAccountId, postedAt])
  @@index([userId, isReversal, voidedAt, postedAt])
  @@index([entityId, isReversal, voidedAt, postedAt])
}
