generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  name                   String?
  passwordHash           String
  financeEntities        FinanceEntity[]
  monthlyOverviewEntries MonthlyOverviewEntry[]
  walletAccounts         WalletAccount[]
  creditAccounts         CreditAccount[]
  investments            Investment[]
  incomeStreams          IncomeStream[]
  budgetEnvelopes        BudgetEnvelope[]
  loanRecords            LoanRecord[]
  financeTransactions    FinanceTransaction[]
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
}

enum WalletAccountType {
  CASH
  BANK
  E_WALLET
  ASSET
  CREDIT_CARD
}

enum TransactionKind {
  INCOME
  EXPENSE
  BUDGET_ALLOCATION
  TRANSFER
  CREDIT_CARD_CHARGE
  CREDIT_CARD_PAYMENT
  LOAN_BORROW
  LOAN_REPAY
  ADJUSTMENT
}

enum LoanDirection {
  YOU_OWE
  YOU_ARE_OWED
}

enum LoanStatus {
  ACTIVE
  PAID
  WRITTEN_OFF
}

enum EntityType {
  PERSONAL
  BUSINESS
}

model FinanceEntity {
  id          String               @id @default(cuid())
  userId      String
  name        String
  type        EntityType
  isArchived  Boolean              @default(false)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallets     WalletAccount[]
  budgets     BudgetEnvelope[]
  loans       LoanRecord[]
  incomeStreams IncomeStream[]
  transactions FinanceTransaction[]

  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([userId, isArchived, createdAt])
}

model MonthlyOverviewEntry {
  id           String   @id @default(cuid())
  userId       String
  entryDate    DateTime
  walletAmount Decimal
  remarks      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, entryDate])
}

model WalletAccount {
  id                  String               @id @default(cuid())
  userId              String
  entityId            String?
  name                String
  type                WalletAccountType
  currentBalanceAmount Decimal              @default(0)
  isArchived          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity              FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  sourceTransactions  FinanceTransaction[] @relation("TransactionSourceWallet")
  targetTransactions  FinanceTransaction[] @relation("TransactionTargetWallet")

  @@index([userId, type, isArchived])
  @@index([userId, isArchived, name])
  @@index([entityId, type, isArchived])
  @@index([entityId, isArchived, name])
}

model CreditAccount {
  id                   String   @id @default(cuid())
  userId               String
  name                 String
  creditLimitAmount    Decimal  @default(0)
  currentBalanceAmount Decimal  @default(0)
  isArchived           Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isArchived, name])
}

model Investment {
  id                   String   @id @default(cuid())
  userId               String
  name                 String
  initialInvestmentPhp Decimal  @default(0)
  value                Decimal  @default(0)
  remarks              String?
  isArchived           Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isArchived, name])
  @@index([userId, createdAt])
}

model IncomeStream {
  id               String               @id @default(cuid())
  userId           String
  entityId         String?
  name             String
  defaultAmountPhp Decimal              @default(0)
  isActive         Boolean              @default(true)
  remarks          String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity           FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  transactions     FinanceTransaction[]

  @@index([userId, isActive])
  @@index([entityId, isActive])
}

model BudgetEnvelope {
  id               String               @id @default(cuid())
  userId           String
  entityId         String?
  name             String
  monthlyTargetPhp Decimal              @default(0)
  availablePhp     Decimal              @default(0)
  rolloverEnabled  Boolean              @default(true)
  payTo            String?
  remarks          String?
  isSystem         Boolean              @default(false)
  isArchived       Boolean              @default(false)
  sortOrder        Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity           FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  transactions     FinanceTransaction[]

  @@index([userId, isArchived, isSystem, sortOrder])
  @@index([userId, name])
  @@index([entityId, isArchived, isSystem, sortOrder])
  @@index([entityId, name])
}

model LoanRecord {
  id            String               @id @default(cuid())
  userId        String
  entityId      String?
  direction     LoanDirection
  itemName      String
  counterparty  String?
  principalPhp  Decimal
  monthlyDuePhp Decimal?
  paidToDatePhp Decimal              @default(0)
  remainingPhp  Decimal
  status        LoanStatus           @default(ACTIVE)
  startDate     DateTime?
  remarks       String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity        FinanceEntity?       @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  transactions  FinanceTransaction[]

  @@index([userId, direction, status])
  @@index([userId, status])
  @@index([entityId, direction, status])
  @@index([entityId, status])
}

model FinanceTransaction {
  id                    String          @id @default(cuid())
  userId                String
  entityId              String?
  postedAt              DateTime        @default(now())
  kind                  TransactionKind
  amountPhp             Decimal
  walletAccountId       String
  targetWalletAccountId String?
  budgetEnvelopeId      String?
  incomeStreamId        String?
  loanRecordId          String?
  countsTowardBudget    Boolean         @default(true)
  remarks               String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity                FinanceEntity?  @relation(fields: [entityId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  walletAccount         WalletAccount   @relation("TransactionSourceWallet", fields: [walletAccountId], references: [id], onDelete: Restrict)
  targetWalletAccount   WalletAccount?  @relation("TransactionTargetWallet", fields: [targetWalletAccountId], references: [id], onDelete: SetNull)
  budgetEnvelope        BudgetEnvelope? @relation(fields: [budgetEnvelopeId], references: [id], onDelete: SetNull)
  incomeStream          IncomeStream?   @relation(fields: [incomeStreamId], references: [id], onDelete: SetNull)
  loanRecord            LoanRecord?     @relation(fields: [loanRecordId], references: [id], onDelete: SetNull)

  @@index([userId, postedAt])
  @@index([userId, kind, postedAt])
  @@index([userId, budgetEnvelopeId, postedAt])
  @@index([userId, walletAccountId, postedAt])
  @@index([entityId, postedAt])
  @@index([entityId, kind, postedAt])
  @@index([entityId, budgetEnvelopeId, postedAt])
  @@index([entityId, walletAccountId, postedAt])
}

